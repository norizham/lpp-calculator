<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LPP Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js for X/Y/Z bar chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg,#e5f0ff,#f5f7fb);
      color: #111827;
    }

    .page {
      max-width: 1300px;
      margin: 20px auto 40px;
      padding: 0 15px;
    }

    /* HEADER */
    .header {
      background: #ffffff;
      border-radius: 14px;
      padding: 14px 18px;
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.10);
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 18px;
    }

    .header-logo {
      width: 80px;
      height: auto;
      flex-shrink: 0;
    }

    .header-text h1 {
      margin: 0;
      font-size: 1.75em;
      letter-spacing: 0.02em;
    }

    .header-text p {
      margin: 4px 0 0;
      font-size: 0.9em;
      color: #4b5563;
    }

    /* LAYOUT */
    .container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      margin-top: 12px;
    }

    .left-column { flex: 1.4; }
    .right-column { flex: 1; }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 18px 20px 20px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.10);
      margin-bottom: 18px;
    }

    h2.section-title {
      margin: 0 0 8px;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h2.section-title span.icon {
      font-size: 1.2em;
    }

    .intro-list {
      font-size: 0.9em;
      color: #4b5563;
      margin: 4px 0 12px 18px;
      padding-left: 4px;
    }

    .intro-list li {
      margin-bottom: 3px;
    }

    fieldset {
      margin-bottom: 14px;
      padding: 12px 14px 14px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }

    legend {
      font-weight: bold;
      font-size: 0.92em;
      padding: 0 6px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.4fr 120px;
      gap: 8px 10px;
      align-items: center;
    }

    label {
      font-size: 0.9em;
      color: #111827;
    }

    input[type="number"] {
      width: 100%;
      padding: 6px 7px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 0.9em;
      background: #ffffff;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
    }

    input[type="number"].error {
      border-color: #dc2626;
      background: #fef2f2;
    }

    .section-subtotal {
      font-weight: bold;
      margin-top: 6px;
      font-size: 0.9em;
      color: #374151;
      text-align: right;
    }

    .section-subtotal span.value { color: #2563eb; }

    .low-score {
      background: #fef2f2 !important;
      border-color: #fecaca !important;
    }

    .final-score-box {
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      padding: 10px 14px;
      border-radius: 12px;
      margin-top: 14px;
      margin-bottom: 12px;
      font-size: 1em;
      font-weight: bold;
      color: #1e3a8a;
    }

    #statusChip {
      display: inline-block;
      margin-top: 4px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.85em;
      background: #e5e7eb;
      color: #374151;
    }

    #minWarning {
      margin-top: 4px;
      font-size: 0.9em;
      color: #b91c1c;
      font-weight: normal;
    }

    #minWarning.ok {
      color: #15803d;
    }

    #progressContainer {
      margin-top: 8px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }

    #progressBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,#22c55e,#16a34a);
      transition: width 0.4s ease;
    }

    .buttons {
      margin: 14px 0 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      padding: 7px 14px;
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid #2563eb;
      background: #2563eb;
      color: #ffffff;
      font-size: 0.9em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    button.secondary {
      background: #ffffff;
      color: #2563eb;
    }

    button.success {
      background: #10b981;
      border-color: #059669;
    }

    button.warning {
      background: #f97316;
      border-color: #ea580c;
    }

    button:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(15,23,42,0.2);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .results {
      background: #f9fafb;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      margin-top: 10px;
      font-size: 0.9em;
    }

    .results h3 {
      margin: 0 0 6px;
      font-size: 0.95em;
      color: #111827;
    }

    .results p {
      margin: 3px 0;
    }

    .disclaimer {
      text-align: center;
      margin-top: 18px;
      color: #6b7280;
      font-size: 0.8em;
    }

    #caseInfo {
      font-size: 0.88em;
    }

    #caseValidation {
      margin-top: 8px;
      font-size: 0.85em;
      color: #b91c1c;
    }

    #caseValidation.ok {
      color: #15803d;
    }

    /* RIGHT COLUMN */
    .right-card {
      background: #ffffff;
      border-radius: 14px;
      padding: 14px 16px 16px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.10);
      margin-bottom: 14px;
    }

    .right-card h2 {
      margin-top: 0;
      font-size: 1.02em;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .right-card small {
      display: block;
      margin-bottom: 4px;
      color: #4b5563;
      font-size: 0.8em;
    }

    .right-card h2 span.icon {
      font-size: 1.1em;
    }

    .card-toggle {
      margin-left: auto;
      font-size: 0.9em;
      color: #6b7280;
    }

    table.info-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82em;
      margin-top: 8px;
    }

    .info-table th,
    .info-table td {
      border: 1px solid #e5e7eb;
      padding: 6px 6px;
      vertical-align: top;
    }

    .info-table th {
      background: #111827;
      color: #f9fafb;
      text-align: left;
      font-weight: 600;
    }

    .info-table tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .badge-note {
      font-size: 0.78em;
      color: #6b7280;
      margin-top: 6px;
    }

    @media (max-width: 900px) {
      .container {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>

<div class="page">

  <!-- HEADER -->
  <header class="header">
    <img src="logo.png" alt="Logo" class="header-logo">
    <div class="header-text">
      <h1>LPP Calculator</h1>
      <p>Quick estimator for X, Y, Z components with case-based guidance and minimum score check (75).</p>
    </div>
  </header>

  <div class="container">

    <!-- LEFT: MAIN CALCULATOR -->
    <div class="left-column">
      <div class="card">

        <h2 class="section-title">
          <span class="icon">ðŸ§®</span>
          <span>Main Calculator</span>
        </h2>

        <ul class="intro-list">
          <li><strong>X1</strong>: Quantitative output (max 60)</li>
          <li><strong>X2</strong>: Publication &amp; grant quality (max 40)</li>
          <li><strong>M3â€“M5</strong>: Leadership, consultancy, service (best 2 â†’ max 28)</li>
          <li><strong>Y</strong>: Output &amp; impact (0â€“10 each â†’ max 20)</li>
          <li><strong>Z</strong>: CPD (0â€“10 â†’ max 10)</li>
        </ul>

        <!-- CASE SELECTOR -->
        <fieldset>
          <legend>M1 &amp; M2 Requirements (Select Case)</legend>

          <label for="mCase"><strong>Select Academic Case:</strong></label>
          <select id="mCase" onchange="onCaseChange()" style="width:100%; padding:6px; margin-top:6px; border-radius:6px; border:1px solid #cbd5e1;">
            <option value="">-- Choose Case --</option>
            <option value="DS11">DS 11</option>
            <option value="DS13">DS 13</option>
            <option value="DS14">DS 14</option>
            <option value="Khas">Khas</option>
          </select>

          <div id="caseInfo" style="
            margin-top:10px;
            padding:8px 10px;
            border:1px solid #d1d5db;
            background:#f3f4f6;
            border-radius:6px;
            display:none;
          "></div>

          <div id="caseValidation"></div>
        </fieldset>

        <!-- X1 -->
        <fieldset>
          <legend>X1 - Quantitative (max 60)</legend>
          <div class="grid">
            <label>M1 Q1 &amp; Q2 (0-100)</label>
            <input id="x1_q1q2" type="number" min="0" max="100" value="0"
                   title="Enter a value between 0 and 100" oninput="calculateLPP()">

            <label>M1 Q1 to Q4 (0-100)</label>
            <input id="x1_q1q4" type="number" min="0" max="100" value="0"
                   title="Enter a value between 0 and 100" oninput="calculateLPP()">

            <label>Grants (0-100)</label>
            <input id="x1_geran" type="number" min="0" max="100" value="0"
                   title="Enter a value between 0 and 100" oninput="calculateLPP()">

            <label>Supervision (0-100)</label>
            <input id="x1_penyeliaan" type="number" min="0" max="100" value="0"
                   title="Enter a value between 0 and 100" oninput="calculateLPP()">

            <label>Teaching (0-100)</label>
            <input id="x1_pengajaran" type="number" min="0" max="100" value="0"
                   title="Enter a value between 0 and 100" oninput="calculateLPP()">
          </div>

          <p class="section-subtotal" id="x1Subtotal">
            X1 subtotal: <span class="value">0.00</span> / 60
          </p>
        </fieldset>

        <!-- X2 -->
        <fieldset>
          <legend>X2 - Publication &amp; Grant Quality (max 40)</legend>
          <div class="grid">
            <label>Publication Quality 1 (0-100)</label>
            <input id="x2_pub1" type="number" min="0" max="100" value="0"
                   title="Enter a value between 0 and 100" oninput="calculateLPP()">

            <label>Publication Quality 2 (0-100)</label>
            <input id="x2_pub2" type="number" min="0" max="100" value="0"
                   title="Enter a value between 0 and 100" oninput="calculateLPP()">

            <label>Grant Quality (0-100)</label>
            <input id="x2_geran" type="number" min="0" max="100" value="0"
                   title="Enter a value between 0 and 100" oninput="calculateLPP()">
          </div>

          <p class="section-subtotal" id="x2Subtotal">
            X2 subtotal: <span class="value">0.00</span> / 40
          </p>
        </fieldset>

        <!-- M3-M5 -->
        <fieldset>
          <legend>M3, M4, M5 - Qualitative (max 28)</legend>
          <div class="grid">
            <label>M3 Leadership (0-100)</label>
            <input id="m3" type="number" min="0" max="100" value="0"
                   title="Enter a value between 0 and 100" oninput="calculateLPP()">

            <label>M4 Consultancy (0-100)</label>
            <input id="m4" type="number" min="0" max="100" value="0"
                   title="Enter a value between 0 and 100" oninput="calculateLPP()">

            <label>M5 Service (0-100)</label>
            <input id="m5" type="number" min="0" max="100" value="0"
                   title="Enter a value between 0 and 100" oninput="calculateLPP()">
          </div>

          <p class="section-subtotal" id="mSubtotal">
            M3-M5 subtotal (best 2): <span class="value">0.00</span> / 28
          </p>
        </fieldset>

        <!-- Y -->
        <fieldset>
          <legend>Y - Output &amp; Impact (max 20)</legend>
          <div class="grid">
            <label>Y1 Output (0-10)</label>
            <input id="y1" type="number" min="0" max="10" value="0"
                   title="Enter a value between 0 and 10" oninput="calculateLPP()">

            <label>Y2 Impact (0-10)</label>
            <input id="y2" type="number" min="0" max="10" value="0"
                   title="Enter a value between 0 and 10" oninput="calculateLPP()">
          </div>

          <p class="section-subtotal" id="ySubtotal">
            Y subtotal: <span class="value">0.00</span> / 20
          </p>
        </fieldset>

        <!-- Z -->
        <fieldset>
          <legend>Z - CPD (max 10)</legend>
          <div class="grid">
            <label>CPD Score (0-10)</label>
            <input id="cpd" type="number" min="0" max="10" value="0"
                   title="Enter a value between 0 and 10" oninput="calculateLPP()">
          </div>

          <p class="section-subtotal" id="cpdSubtotal">
            CPD subtotal: <span class="value">0.00</span> / 10
          </p>
        </fieldset>

        <!-- FINAL SCORE -->
        <div class="final-score-box">
          <p id="finalScoreTop">FINAL LPP SCORE: 0.00 / 100</p>
          <p id="statusChip"></p>
          <p id="minWarning"></p>
          <div id="progressContainer">
            <div id="progressBar"></div>
          </div>
        </div>

        <!-- BUTTONS -->
        <div class="buttons">
          <button onclick="calculateLPP()"><span>â–¶</span><span>Calculate</span></button>
          <button class="secondary" onclick="resetForm()"><span>ðŸ§¹</span><span>Clear outputs</span></button>
          <button class="success" onclick="resetToZero()"><span>âŸ³</span><span>Reset inputs to zero</span></button>
          <button class="warning" onclick="setAllToMax()"><span>â¬†</span><span>Set all inputs to max</span></button>
        </div>

        <!-- RESULTS -->
        <div class="results" id="results">
          <h3>Detailed Results</h3>
          <p id="x1Result"></p>
          <p id="x2Result"></p>
          <p id="comp42Result"></p>
          <p id="m3m4m5Result"></p>
          <p id="totalXResult"></p>
          <p id="y1y2Result"></p>
          <p id="cpdResult"></p>
          <p id="breakdownResult"></p>
          <p id="finalResult"></p>

          <canvas id="xyzChart" style="margin-top:8px; max-height:180px;"></canvas>
        </div>

      </div>

      <p class="disclaimer">
        Disclaimer: This calculator and tables are illustrative tools only. Use at your own risk and refer to official LPP guidelines for final decisions.
      </p>
    </div>

    <!-- RIGHT: TABLES -->
    <div class="right-column">

      <!-- PUBLICATION TABLE -->
      <div class="right-card">
        <h2 onclick="toggleCard('pubCardBody','pubCardToggle')">
          <span class="icon">ðŸ“š</span>
          <span>Publication Quality Marks (M1 â€“ X2)</span>
          <span class="card-toggle" id="pubCardToggle">â–¼</span>
        </h2>
        <small>Use this as a reference when assigning publication scores in X1 and X2.</small>
        <div id="pubCardBody">
          <table class="info-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Database / Output</th>
                <th>Role</th>
                <th>Marks</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1</td>
                <td>Index Journal Q1/Q2 WOS / Scopus</td>
                <td>First / Corresponding / Sole Author</td>
                <td>100</td>
              </tr>
              <tr>
                <td>2</td>
                <td>Research Book (Index / MAPIM)</td>
                <td>First Author</td>
                <td>100</td>
              </tr>
              <tr>
                <td>3</td>
                <td>Index Journal Q3/Q4 WOS / Scopus</td>
                <td>First / Corresponding / Sole Author</td>
                <td>70</td>
              </tr>
              <tr>
                <td>4</td>
                <td>Research Book (Index / MAPIM)</td>
                <td>Co-author</td>
                <td>50</td>
              </tr>
              <tr>
                <td>5</td>
                <td>Chapter in research book (Index / MAPIM)</td>
                <td>First Author</td>
                <td>50</td>
              </tr>
              <tr>
                <td>6</td>
                <td>Chapter in research book (Index / MAPIM)</td>
                <td>Co-author</td>
                <td>25</td>
              </tr>
              <tr>
                <td>7</td>
                <td>Index Journal other than WOS and Scopus (ERA / MyCite)</td>
                <td>First / Corresponding / Sole Author</td>
                <td>50</td>
              </tr>
              <tr>
                <td>8</td>
                <td>Index Journal Q1/Q2 WOS / Scopus</td>
                <td>Co-author</td>
                <td>40</td>
              </tr>
              <tr>
                <td>9</td>
                <td>Index Journal Q3/Q4 WOS / Scopus</td>
                <td>Co-author</td>
                <td>30</td>
              </tr>
              <tr>
                <td>10</td>
                <td>Index Journal other than WOS and Scopus (ERA / MyCite)</td>
                <td>Co-author</td>
                <td>30</td>
              </tr>
              <tr>
                <td>11</td>
                <td>Non Index Journal</td>
                <td>First / Corresponding / Sole Author</td>
                <td>30</td>
              </tr>
              <tr>
                <td>12</td>
                <td>Indexed Proceedings</td>
                <td>First / Corresponding / Sole Author</td>
                <td>10</td>
              </tr>
            </tbody>
          </table>
          <div class="badge-note">
            Note: Use WOS and Scopus together to classify Q1â€“Q4 journals.
          </div>
        </div>
      </div>

      <!-- GRANT TABLE -->
      <div class="right-card">
        <h2 onclick="toggleCard('grantCardBody','grantCardToggle')">
          <span class="icon">ðŸ’°</span>
          <span>Grant Marks (M1 â€“ X2)</span>
          <span class="card-toggle" id="grantCardToggle">â–¼</span>
        </h2>
        <small>Reference for assigning grant-related marks in X1 and X2.</small>
        <div id="grantCardBody">
          <table class="info-table">
            <thead>
              <tr>
                <th>No.</th>
                <th>Grant Status</th>
                <th>Marks</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1</td>
                <td>Grant received / active as Main Researcher</td>
                <td>100</td>
              </tr>
              <tr>
                <td>2</td>
                <td>Grant applied as Main Researcher</td>
                <td>40</td>
              </tr>
              <tr>
                <td>3</td>
                <td>Grant received / active as Co-Researcher</td>
                <td>30</td>
              </tr>
            </tbody>
          </table>
          <div class="badge-note">
            Note: Only the highest applicable grant mark is typically counted.
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<script>
  // ---- CASE CONFIG (descriptions, autofill, minimum thresholds) ----
  var CASE_CONFIG = {
    "DS11": {
      description: `
        <strong>M1 (Research/Publications)</strong><br>
        â€¢ 1 Ã— Q1/Q2 WOS journal (Corresponding author â€“ published)<br>
        â€¢ 1 Ã— Q3/Q4 WOS/Scopus journal (Corresponding author â€“ published)<br>
        â€¢ 1 Ã— Research Grant (Project Leader, active)<br><br>
        <strong>M2 (Teaching/Supervision)</strong><br>
        â€¢ 5 hours academic teaching (UG/PG course/lab)<br>
        â€¢ 1 Ã— PG Supervision (active)<br><br>
        <em>Auto-filled marks represent a reasonable target profile; adjust as needed.</em>
      `,
      autofill: {
        x1_q1q2: 80,
        x1_q1q4: 70,
        x1_geran: 80,
        x1_penyeliaan: 80,
        x1_pengajaran: 80
      },
      min: {
        x1_q1q2: 60,
        x1_q1q4: 50,
        x1_geran: 60,
        x1_penyeliaan: 60,
        x1_pengajaran: 60
      }
    },
    "DS13": {
      description: `
        <strong>M1 (Research/Publications)</strong><br>
        â€¢ 1 Ã— Q1/Q2 WOS journal (Corresponding author â€“ published)<br>
        â€¢ 1 Ã— Q3/Q4 WOS/Scopus journal (Corresponding author â€“ published)<br>
        â€¢ 1 Ã— Research Grant (Project Leader, active)<br><br>
        <strong>M2 (Teaching/Supervision)</strong><br>
        â€¢ 5 hours academic teaching (UG/PG course/lab)<br>
        â€¢ 1 Ã— PG Supervision (active)<br><br>
        <em>Auto-filled marks represent a reasonable target profile; adjust as needed.</em>
      `,
      autofill: {
        x1_q1q2: 80,
        x1_q1q4: 70,
        x1_geran: 80,
        x1_penyeliaan: 80,
        x1_pengajaran: 80
      },
      min: {
        x1_q1q2: 60,
        x1_q1q4: 50,
        x1_geran: 60,
        x1_penyeliaan: 60,
        x1_pengajaran: 60
      }
    },
    "DS14": {
      description: `
        <strong>M1 (Research/Publications)</strong><br>
        â€¢ 2 Ã— Q1/Q2 WOS journals (Corresponding author â€“ published)<br>
        â€¢ 1 Ã— Research Grant (Project Leader, active)<br><br>
        <strong>M2 (Teaching/Supervision)</strong><br>
        â€¢ 5 hours academic teaching (UG/PG course/lab)<br>
        â€¢ 1 Ã— PG Supervision (active)<br><br>
        <em>Auto-filled marks represent a higher target profile for senior staff; adjust as needed.</em>
      `,
      autofill: {
        x1_q1q2: 90,
        x1_q1q4: 85,
        x1_geran: 90,
        x1_penyeliaan: 90,
        x1_pengajaran: 90
      },
      min: {
        x1_q1q2: 80,
        x1_q1q4: 70,
        x1_geran: 80,
        x1_penyeliaan: 80,
        x1_pengajaran: 80
      }
    },
    "Khas": {
      description: `
        <strong>M1 (Research/Publications)</strong><br>
        â€¢ 2 Ã— Q1/Q2 WOS journals (Corresponding author â€“ published)<br>
        â€¢ 1 Ã— Research Grant (Project Leader, active)<br><br>
        <strong>M2 (Teaching/Supervision)</strong><br>
        â€¢ 5 hours academic teaching (UG/PG course/lab)<br>
        â€¢ 1 Ã— PG Supervision (active)<br><br>
        <em>Auto-filled marks represent a higher target profile for special cases; adjust as needed.</em>
      `,
      autofill: {
        x1_q1q2: 90,
        x1_q1q4: 85,
        x1_geran: 90,
        x1_penyeliaan: 90,
        x1_pengajaran: 90
      },
      min: {
        x1_q1q2: 80,
        x1_q1q4: 70,
        x1_geran: 80,
        x1_penyeliaan: 80,
        x1_pengajaran: 80
      }
    }
  };

  function fieldLabel(id) {
    switch (id) {
      case 'x1_q1q2': return 'M1 Q1 & Q2 (0-100)';
      case 'x1_q1q4': return 'M1 Q1 to Q4 (0-100)';
      case 'x1_geran': return 'Grants (0-100)';
      case 'x1_penyeliaan': return 'Supervision (0-100)';
      case 'x1_pengajaran': return 'Teaching (0-100)';
      default: return id;
    }
  }

  function onCaseChange() {
    var sel = document.getElementById('mCase').value;
    var infoBox = document.getElementById('caseInfo');
    var valBox = document.getElementById('caseValidation');
    valBox.textContent = '';
    valBox.classList.remove('ok');

    if (!sel || !CASE_CONFIG[sel]) {
      infoBox.style.display = 'none';
      infoBox.innerHTML = '';
      calculateLPP();
      return;
    }

    var cfg = CASE_CONFIG[sel];
    infoBox.style.display = 'block';
    infoBox.innerHTML = cfg.description;

    // Auto-fill suggested marks for M1 and M2
    Object.keys(cfg.autofill).forEach(function(id) {
      var el = document.getElementById(id);
      if (el) {
        el.value = cfg.autofill[id];
        el.classList.remove('error');
      }
    });

    calculateLPP();
    validateCase(); // run validation immediately
  }

  function validateCase() {
    var sel = document.getElementById('mCase').value;
    var valBox = document.getElementById('caseValidation');
    valBox.textContent = '';
    valBox.classList.remove('ok');

    if (!sel || !CASE_CONFIG[sel]) return;

    var cfgMin = CASE_CONFIG[sel].min;
    var messages = [];

    Object.keys(cfgMin).forEach(function(id) {
      var current = parseFloat(document.getElementById(id).value) || 0;
      var minVal = cfgMin[id];
      if (current < minVal) {
        messages.push('â€¢ ' + fieldLabel(id) + ': current ' + current + ', recommended minimum ' + minVal);
      }
    });

    if (messages.length === 0) {
      valBox.textContent = 'Current marks meet or exceed the recommended minimum for case ' + sel + '.';
      valBox.classList.add('ok');
    } else {
      valBox.innerHTML = '<strong>Warning:</strong><br>' + messages.join('<br>');
    }
  }

  // Clamp values
  function val(id) {
    var el = document.getElementById(id);
    var v = parseFloat(el.value);

    var maxVal = (id === 'y1' || id === 'y2' || id === 'cpd') ? 10 : 100;

    var outOfRange = false;

    if (isNaN(v)) v = 0;
    if (v < 0) { v = 0; outOfRange = true; }
    if (v > maxVal) { v = maxVal; outOfRange = true; }

    if (outOfRange) el.classList.add('error');
    else el.classList.remove('error');

    el.value = v;
    return v;
  }

  var xyzChart;

  function updateXYZChart(totalX, yTotal, cpdScore) {
    var canvas = document.getElementById('xyzChart');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    if (!xyzChart) {
      xyzChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['X (max 70)', 'Y (max 20)', 'Z (max 10)'],
          datasets: [{
            label: 'Score',
            data: [totalX, yTotal, cpdScore]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: 70
            }
          }
        }
      });
    } else {
      xyzChart.data.datasets[0].data = [totalX, yTotal, cpdScore];
      xyzChart.update();
    }
  }

  function calculateLPP() {
    var r = function(x) { return x.toFixed(2); };

    // X1
    var C4 = val('x1_q1q2');
    var C5 = val('x1_q1q4');
    var C6 = val('x1_geran');
    var C7 = val('x1_penyeliaan');
    var C8 = val('x1_pengajaran');

    var sumX1 = C4 + C5 + C6 + C7 + C8;
    var x1Raw = (sumX1 / 500) * 60;
    var x1Avg = sumX1 / 5;

    document.getElementById('x1Subtotal').innerHTML =
      'X1 subtotal: <span class="value">' + r(x1Raw) + '</span> / 60';

    // X2
    var C10 = val('x2_pub1');
    var C11 = val('x2_pub2');
    var C12 = val('x2_geran');

    var x2Raw = ((((C10 + C11) / 200) + (C12 / 100)) / 2) * 40;

    document.getElementById('x2Subtotal').innerHTML =
      'X2 subtotal: <span class="value">' + r(x2Raw) + '</span> / 40';

    // Quantitative component (42%)
    var comp42 = ((x1Raw + x2Raw) / 100) * 42;

    // M3-M5 best 2
    var arr = [val('m3'), val('m4'), val('m5')].sort(function(a,b){return b-a;});
    var mBestAvg = (arr[0] + arr[1]) / 2;
    var mScore = (mBestAvg / 100) * 28;

    document.getElementById('mSubtotal').innerHTML =
      'M3-M5 subtotal (best 2): <span class="value">' + r(mScore) + '</span> / 28';

    var totalX = comp42 + mScore; // up to 70

    // Y
    var y1v = val('y1');
    var y2v = val('y2');
    var yTotal = y1v + y2v;

    document.getElementById('ySubtotal').innerHTML =
      'Y subtotal: <span class="value">' + r(yTotal) + '</span> / 20';

    // CPD
    var cpdScore = val('cpd');

    document.getElementById('cpdSubtotal').innerHTML =
      'CPD subtotal: <span class="value">' + r(cpdScore) + '</span> / 10';

    // FINAL TOTAL
    var finalTotal = totalX + yTotal + cpdScore;

    // Final score text
    document.getElementById('finalScoreTop').textContent =
      'FINAL LPP SCORE: ' + r(finalTotal) + ' / 100';

    // Detailed results
    document.getElementById('x1Result').textContent =
      'X1 = ' + r(x1Raw) + ' / 60 (avg input = ' + r(x1Avg) + ')';
    document.getElementById('x2Result').textContent =
      'X2 = ' + r(x2Raw) + ' / 40';
    document.getElementById('comp42Result').textContent =
      'Quantitative Component (42%) = ' + r(comp42) + ' / 42';
    document.getElementById('m3m4m5Result').textContent =
      'M3-M5 (best 2 of 3) = ' + r(mScore) + ' / 28';
    document.getElementById('totalXResult').textContent =
      'Total X = ' + r(totalX) + ' / 70';
    document.getElementById('y1y2Result').textContent =
      'Y total = ' + r(yTotal) + ' / 20';
    document.getElementById('cpdResult').textContent =
      'CPD = ' + r(cpdScore) + ' / 10';
    document.getElementById('breakdownResult').textContent =
      'Contribution: X = ' + r(totalX) +
      ', Y = ' + r(yTotal) +
      ', Z = ' + r(cpdScore);
    document.getElementById('finalResult').textContent =
      'FINAL LPP SCORE = ' + r(finalTotal) + ' / 100';

    // Min 75 logic
    var minRequired = 75;
    var warnEl = document.getElementById('minWarning');
    warnEl.classList.remove('ok');

    var statusChip = document.getElementById('statusChip');

    if (finalTotal >= minRequired) {
      warnEl.textContent = 'You meet the minimum recommended total of 75.';
      warnEl.classList.add('ok');
      statusChip.textContent = 'ðŸŸ¢ On track';
      statusChip.style.background = '#dcfce7';
      statusChip.style.color = '#166534';
    } else {
      var diff = (minRequired - finalTotal).toFixed(2);
      var suggestions = [];

      if (totalX < 55) {
        suggestions.push('â€¢ Increase X (research, grants, leadership/service). Focus on higher-quality publications, stronger grants, and M3â€“M5 activities.');
      }
      if (yTotal < 15) {
        suggestions.push('â€¢ Improve Y by documenting more impactful outputs and outcomes. Aim closer to 8â€“10 for Y1 and Y2 where appropriate.');
      }
      if (cpdScore < 8) {
        suggestions.push('â€¢ Add CPD activities (courses, workshops, professional training) to raise Z towards 8â€“10.');
      }
      if (suggestions.length === 0) {
        suggestions.push('â€¢ Small improvements across X, Y and Z (for example +1â€“2 points in several items) will help close the gap.');
      }

      warnEl.innerHTML =
        'Score below minimum 75. You need approximately ' + diff +
        ' more marks to reach 75.<br>' +
        suggestions.join('<br>');

      // status chip levels
      if (finalTotal >= 65) {
        statusChip.textContent = 'ðŸŸ¡ Close to target';
        statusChip.style.background = '#fef9c3';
        statusChip.style.color = '#854d0e';
      } else {
        statusChip.textContent = 'ðŸ”´ Below target';
        statusChip.style.background = '#fee2e2';
        statusChip.style.color = '#991b1b';
      }
    }

    // Progress bar towards 75
    var progress = Math.min(finalTotal, minRequired) / minRequired * 100;
    document.getElementById('progressBar').style.width = progress + '%';

    // Low-score highlighting reset
    ['x1Subtotal','x2Subtotal','mSubtotal','ySubtotal','cpdSubtotal'].forEach(function(id){
      document.getElementById(id).classList.remove('low-score');
    });

    // Apply low-score highlighting
    if (totalX < 50) document.getElementById('mSubtotal').classList.add('low-score');
    if (yTotal < 12) document.getElementById('ySubtotal').classList.add('low-score');
    if (cpdScore < 6) document.getElementById('cpdSubtotal').classList.add('low-score');

    // Update chart
    updateXYZChart(totalX, yTotal, cpdScore);

    // Scroll to results
    document.getElementById('results').scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });

    // Re-run validation whenever calculation changes
    validateCase();
  }

  function resetForm() {
    var ps = document.querySelectorAll('#results p');
    ps.forEach(function(p){ p.textContent = ''; });

    document.getElementById('finalScoreTop').textContent =
      'FINAL LPP SCORE: 0.00 / 100';

    document.getElementById('x1Subtotal').innerHTML =
      'X1 subtotal: <span class="value">0.00</span> / 60';
    document.getElementById('x2Subtotal').innerHTML =
      'X2 subtotal: <span class="value">0.00</span> / 40';
    document.getElementById('mSubtotal').innerHTML =
      'M3-M5 subtotal (best 2): <span class="value">0.00</span> / 28';
    document.getElementById('ySubtotal').innerHTML =
      'Y subtotal: <span class="value">0.00</span> / 20';
    document.getElementById('cpdSubtotal').innerHTML =
      'CPD subtotal: <span class="value">0.00</span> / 10';

    var valBox = document.getElementById('caseValidation');
    valBox.textContent = '';
    valBox.classList.remove('ok');

    var warnEl = document.getElementById('minWarning');
    warnEl.textContent = '';
    warnEl.classList.remove('ok');

    var statusChip = document.getElementById('statusChip');
    statusChip.textContent = '';
    statusChip.style.background = '#e5e7eb';
    statusChip.style.color = '#374151';

    document.getElementById('progressBar').style.width = '0%';

    // Remove low-score highlight
    ['x1Subtotal','x2Subtotal','mSubtotal','ySubtotal','cpdSubtotal'].forEach(function(id){
      document.getElementById(id).classList.remove('low-score');
    });
  }

  function resetToZero() {
    var inputs = document.querySelectorAll('input[type="number"]');
    inputs.forEach(function(i){
      i.value = 0;
      i.classList.remove('error');
    });
    resetForm();
    calculateLPP();
  }

  function setAllToMax() {
    var inputs = document.querySelectorAll('input[type="number"]');
    inputs.forEach(function(i){
      var id = i.id;
      var maxVal = (id === 'y1' || id === 'y2' || id === 'cpd') ? 10 : 100;
      i.value = maxVal;
      i.classList.remove('error');
    });
    resetForm();
    calculateLPP();
  }

  function toggleCard(bodyId, toggleId) {
    var body = document.getElementById(bodyId);
    var toggle = document.getElementById(toggleId);
    if (!body || !toggle) return;
    if (body.style.display === 'none') {
      body.style.display = 'block';
      toggle.textContent = 'â–¼';
    } else {
      body.style.display = 'none';
      toggle.textContent = 'â–²';
    }
  }

  window.addEventListener('DOMContentLoaded', resetToZero);
</script>

</body>
</html>
